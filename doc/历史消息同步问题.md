## 1. 私聊消息同步

### 1.1拖动页面会进入加载状态:
```kotlin
   fun onLoadHistoryMessageOnDrag()
```

内部区分系统消息，私聊，群聊三种；

```kotlin
// 页面上下拉控件，触发事件， 加载历史数据:  {私聊的数据，先尝试本地加载，这里是从向前边的历史数据开始加载}
fun onLoadP2pHistoryMessageOnDrag(session:ChatSession, firstMsg:MessageContent?){
        var firstId = Long.MAX_VALUE
        if (firstMsg != null){
            firstId= firstMsg.msgId
        }
        // 向前加载
        val lst = TopicDbHelper.getPChatMessagesById(session.tid, firstId, SdkGlobalData.LOAD_MSG_BATCH, false)
        if (lst != null && lst.size > 0){
            firstId = lst.first().id
        }

        val chatSession = session

        // 添加到界面消息列表中
        chatSession.addP2PMessageToHeadOnDrag(lst, session, false)
        SdkGlobalData.invokeOnEventCallbacks(MsgEventType.MSG_HISTORY, 0, 0, session.getSessionId(), mapOf("from" to "db"))

        // 如果数据库里面的消息太少，这里还需要去服务器找
        if (lst == null || lst.size < SdkGlobalData.LOAD_MSG_BATCH){
            MsgEncocder.sendSynChatDataBackward(firstId, session.getSessionId(), 0)
        }else{
            // 如果是刚刚好，那么等待拖动界面下一次加载，这里啥也不做了
        }
    }
```

逻辑相对简单：

从数据库加载，如果数据库中加载不到足够的数据就请求去远端加载；

界面收到MsgEventType.MSG_HISTORY消息，就算是刷新结束了；如果没有反馈5秒也会自动结束刷新状态；



###  1.2 登录时候加载

登录后先对每个可见的会话加载本地消息；

之后根据本地数据库中的最后的消息记录，向服务器对uid发起所有的未加载的数据的查询，直到补全所有私聊消息为止。

备注：本地私聊消息也是存储在一个大表中，各个私聊对话是对消息的索引，然后用视图的方式展示的。



## 2. 群聊消息同步问题

群聊消息的同步比较麻烦，有一种情况是：某个用户长时间的未登录，那么本地群的消息针对这段时间就会缺少很多；如果直接加载，如果需要保证消息连续，则可能需要加载很多的数据；

```kotlin
fun loadPMessageFormDbOnLogin()
```

这个函数中不再加载本地群聊数据；



## 3. 系统消息同步问题

###  3.1 关注与取消

- 这个消息在服务端存储
- 如果用户在线，则实时推送给用户，同步信息；
- 如果用户不在线，登录后会同步粉丝和关注，其实不需要同步相关操作；

### 3.2 申请加入群

1. 如果是"direct"类型，则搜索群直接加入就可以了；

2. 如果是"invite"类型，需要管理员在群内邀请用户；

3. 如果是"question"类型，回答问题正确就可以直接加入；

4. 如果是"auth"类型，需要管理员同意；

   总结：管理员审批的消息，用户收到的邀请消息，这2类在登录后需要同步；所以服务端也需要针对这个缓存；

   **这类消息在ScyllaDb中以群组和个人操作记录的方式存储，客户端不需要再存储这个了，直接从服务端拉取并设置结果就可以了；**

   登录成功后，直接反向加载用户操作记录，包括被邀请入群的，以及需要审批的；

   通常情况下，客户端需要处理2类消息：

   1）入群的申请消息；

   2）邀请的入群消息；

### 3.3 用户入群通知

- 所有群组用户都会收到这个消息，但是如果放在系统消息中就会太多了
- 考虑使用系统账户发送一条普通的群消息，“某某用户加入到群”，“某某用户退出群聊”，“某某用户成为管理员”，



